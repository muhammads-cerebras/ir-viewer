#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CALL_DIR="$(pwd)"

UV_BIN="$ROOT_DIR/.uv/uv"
if [[ ! -x "$UV_BIN" ]]; then
  echo "Installing uv ..."
  mkdir -p "$ROOT_DIR/.uv"
  curl -LsSf https://astral.sh/uv/install.sh | UV_INSTALL_DIR="$ROOT_DIR/.uv" sh
fi
export PATH="$ROOT_DIR/.uv:$PATH"

if [[ ! -d "$ROOT_DIR/.venv" ]]; then
  echo "Setting up environment (uv sync)..."
  "$UV_BIN" sync --project "$ROOT_DIR"
fi

IR_PATH=""
if [[ $# -gt 0 && "${1:-}" != -* ]]; then
  if [[ "$1" = /* ]]; then
    IR_PATH="$1"
  else
    IR_PATH="$CALL_DIR/$1"
  fi
  shift || true
else
  IR_PATH="$CALL_DIR/ir.mlir"
fi

"$UV_BIN" run --project "$ROOT_DIR" ir-viewer "$IR_PATH" "$@"
